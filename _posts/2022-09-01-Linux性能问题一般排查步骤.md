---
layout: post
title: "linux性能问题一般排查步骤"
tags: ["linux", "arthas"]
---

## CPU部分
### uptime
```shell
$ uptime
 10:06:11 up 3 days, 5 min,  2 users,  load average: 0.52, 0.67, 0.64
```
查看系统运行时间和最近一段时间的cpu负载。从左到右依次为
+ *10：06：11*   当前时间
+ *up 3 days , 5 min*   系统启动到当前已运行3天五分钟
+ *2 users*   当前在线用户
+ *load average： 0.52, 0.67, 0.64*    三个数字从左到右表示系统最近一分钟、五分钟、十五分钟的平均cpu负载

### dmesg
dmesg命令用于查看系统日志，可以通过dmesg|tail查看最新的日志
```shell
dmesg | tail
[106934.201793] Code: 00 00 00 c3 90 0f 1f 40 0 
[106985.928166] dde-lock[286349]: segfault at 8 ip
[106985.928173] Code: 00 00 00 c3 90 0f 1f 40 00 
[110819.381112] dde-lock[294508]: segfault at 8 
[110819.381118] Code: 00 00 00 c3 90 0f 1f 40 00 
[115993.530373] perf: interrupt took too long (3146 > 3142), lowering kernel.perf_event_max_sample_rate to 63500
[171341.053499] dde-lock[377378]: segfault at 8 ip 00007fbbded62ab1 sp 
[171341.053506] Code: 00 00 00 c3 90 0f 1f 40 00 48 8b 
[210552.586042] systemd-journald[18137]: 
[210552.586046] systemd-journald[18137]: 
```
注意日志中是否有error或其他可能影响性能的问题
> dmesg展示的是内核的日志，我们还可以参考/val/log/messages文件，这个文件里不仅包含内核日志，也包含应用的日志。
> 更多查看日志工具可以参见[linux日志收集工具](_posts/2021-12-14-Linux日志收集工具.md)

### vmstat
```shell
# vmstat -w 1
procs -----------------------memory---------------------- ---swap-- -----io---- -system-- --------cpu--------
 r  b         swpd         free         buff        cache   si   so    bi    bo   in   cs  us  sy  id  wa  st
 2  0      1479680       163860            0     12178096    1    1   167   304    0    1  11   5  83   0   0
 2  0      1479680       160016            0     12181880    0   16     0    16 3929 21341  35   6  60   0   0
 2  0      1479680       178336            0     12164300    0   12     0  3404 4634 20897  35   6  59   0   0
 2  0      1479680       172428            0     12169196    0   72     0    72 3931 21526  35   6  60   0   0
 5  0      1479680       160680            0     12181092    0    0     0     0 6794 17008  64   5  31   0   0
```
-w参数用于调整输出格式，可以忽略。后面的1表示每隔1秒再次输出。输出结果解析如下：
+ ***procs***部分
    + ***r***    runnable状态的进程数量（正在运行或者等待cpu分片）
    + ***b***    处于不可中断等待（uninterruptible sleep）的进程数量，通常指正在I/O的进程
+ ***memory***部分，和free命令结果差不多，这里不再详细列出
+ ***swap***部分
    + ***si***   swap in，从磁盘交换到内存的速度
    + ***so***   swap out，从内存交换到磁盘的速度
  如果这两个值都不为0且比较大，表示内存不足，内存页在磁盘和内存频繁交换，速度为每秒的平均速度
+ ***io***部分
    + ***bi***   从块设备读入block的速度
    + ***bo***   将block写入块设备的速度
  这里块设备通常是磁盘，表示磁盘I/O的速度，为每秒的平均速度
+ ***system***部分
    * ***in***   interrupt，中断数量
    * ***cs***   context switch，上下文切换数量
  中断上下文切换多说明运行的进程多，都需要cpu资源，这两个数量都是平均每秒的数量
+ ***cpu***部分
    + ***us***   user，cpu在用户空间运行时长百分比
    + ***sy***   system，cpu在内核空间运行时长百分比
    + ***id***   idle，cpu空闲时间百分比
    + ***wa***   wait，cpu等待I/O时间百分比
    + ***st***   stolen，如果当前在虚拟机环境中运行，这个时长表示在另外一台机器（宿主机）的百分比

### mpstat
mpstat用于查看每个cpu（多核cpu则每个单独展示）的状态。常用的是-P和-I参数

#### -P参数
```shell
mpstat -P ALL 1
Linux 3.10.0-957.27.2.el7.x86_64 (localhost)    2022年09月01日  _x86_64_        (4 CPU)

16时26分20秒  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
16时26分21秒  all    9.50    0.00    5.75    0.00    0.00    0.00    0.00    0.00    0.00   84.75
16时26分21秒    0    8.91    0.00    4.95    0.00    0.00    0.00    0.00    0.00    0.00   86.14
16时26分21秒    1   11.00    0.00    9.00    0.00    0.00    0.00    0.00    0.00    0.00   80.00
16时26分21秒    2    8.16    0.00    3.06    0.00    0.00    0.00    0.00    0.00    0.00   88.78
16时26分21秒    3    8.91    0.00    5.94    0.00    0.00    0.00    0.00    0.00    0.00   85.15

16时26分21秒  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
16时26分22秒  all   10.08    0.00    4.79    0.00    0.00    0.00    0.00    0.00    0.00   85.14
16时26分22秒    0   12.00    0.00    6.00    0.00    0.00    0.00    0.00    0.00    0.00   82.00
16时26分22秒    1   10.10    0.00    5.05    0.00    0.00    0.00    0.00    0.00    0.00   84.85
16时26分22秒    2    9.00    0.00    4.00    0.00    0.00    0.00    0.00    0.00    0.00   87.00
16时26分22秒    3   10.00    0.00    4.00    0.00    0.00    0.00    0.00    0.00    0.00   86.00
```
***-P***参数会打印处理器的cpu占用，***ALL***表示打印所有处理器，还可以指定，从0开始编号。***1***表示每1秒输出一次

#### -I参数
-I参数用于查看cpu的终端数量，有多个选项
```shell
# mpstat -I SUM 1
Linux 3.10.0-957.27.2.el7.x86_64 (localhost)    2022年09月01日  _x86_64_        (4 CPU)

16时54分17秒  CPU    intr/s
16时54分18秒  all   2061.00
16时54分19秒  all   2001.00
```
***SUM***会输出平均每个处理器每秒的中断数量，***1***表示1秒输出一次

```shell
# mpstat -I CPU 1
Linux 3.10.0-957.27.2.el7.x86_64 (localhost)    2022年09月01日  _x86_64_        (4 CPU)

16时56分33秒  CPU        0/s        8/s        9/s       16/s      120/s      121/s      122/s      123/s      124/s      125/s      126/s      127/s      128/s      129/s      130/s      131/s      132/s      133/s      134/s      135/s      136/s      137/s      138/s      139/s      140/s      141/s      142/s      143/s      144/s      145/s      146/s      147/s      148/s      149/s      150/s      151/s      152/s      153/s      154/s      NMI/s      LOC/s      SPU/s      PMI/s      IWI/s      RTR/s      RES/s      CAL/s      TLB/s      TRM/s      THR/s      DFR/s      MCE/s      MCP/s      ERR/s      MIS/s      PIN/s      NPI/s      PIW/s
16时56分33秒    0       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.02       0.02       0.01       0.01       0.01       0.01       0.01       0.01       0.68       0.00       0.00       0.08      33.96       0.10       2.74       0.06       4.01       0.04       1.54       0.03       0.00       0.02       0.02       0.01       0.02       0.02       0.01       0.02       0.00       0.01     428.37       0.00       0.01       0.83       0.00      31.16    1349.15      62.13       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00
16时56分33秒    1       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.02       0.02       0.02       0.02       0.01       0.01       0.01       0.01       4.43       0.00       0.00       0.04      21.05       0.03       0.38       0.04       5.34       0.05       0.85       0.06       0.00       0.02       0.03       0.02       0.02       0.02       0.01       0.02       0.00       0.01     424.46       0.00       0.01       0.83       0.00      31.77    1349.15      63.74       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00
16时56分33秒    2       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.02       0.02       0.02       0.02       0.03       0.02       0.01       0.01       2.36       0.00       0.00       0.15      13.38       0.13       2.97       0.05       1.73       0.05       0.70       0.07       0.00       0.03       0.02       0.02       0.02       0.01       0.01       0.01       0.00       0.01     428.91       0.00       0.01       0.79       0.00      29.80    1349.15      61.96       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00
16时56分33秒    3       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.44       0.44       0.45       0.45       0.45       0.47       0.47       0.46       3.18       0.00       0.00       0.23      13.60       0.23       7.31       0.35       6.42       0.36       9.66       0.33       0.00       0.43       0.42       0.45       0.44       0.45       0.46       0.45       0.00       0.01     428.14       0.00       0.01       0.92       0.00      30.56    1349.15      62.39       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00       0.00
```

***CPU***会输出每个处理器的中断数量，***1***表示每秒输出一次

```shell
# mpstat -I SCPU 1
Linux 3.10.0-957.27.2.el7.x86_64 (localhost)    2022年09月01日  _x86_64_        (4 CPU)

16时58分05秒  CPU       HI/s    TIMER/s   NET_TX/s   NET_RX/s    BLOCK/s BLOCK_IOPOLL/s  TASKLET/s    SCHED/s  HRTIMER/s      RCU/s
16时58分06秒    0       0.00     414.00       0.00      36.00       0.00       0.00       0.00     121.00       0.00     261.00
16时58分06秒    1       0.00     471.00       0.00       0.00       0.00       0.00       0.00     121.00       0.00     275.00
16时58分06秒    2       0.00     387.00       0.00       2.00       0.00       0.00       0.00     108.00       0.00     289.00
16时58分06秒    3       0.00     382.00       0.00       9.00       0.00       0.00       0.00      96.00       0.00     255.00
```
***SCPU***用于输出每个处理器每秒的软中断数量，***1***表示每秒输出一次

>通常情况下直接使用mpstat -I ALL打印上面所有的输出

>mpstat的硬中断数据来自于/proc/interrupts文件，软中断来自/proc/softirqs文件，如果不太清楚某个中断的
> 含义，可以查看这两个文件是否有具体描述

### pidstat
pidstat 类似于top，但是它不会像top一样覆盖已有输出，而是滚动输出，适合保留进程的占用历史记录。
```shell
# pidstat 1
Linux 5.10.101-amd64-desktop (user-PC)  2022年09月06日  _x86_64_        (4 CPU)

11时34分26秒   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
11时34分27秒     0       628    0.99    0.00    0.00    0.00    0.99     3  oray_rundaemon
11时34分27秒     0       687    0.00    0.99    0.00    0.00    0.99     3  sunloginclient                                                                                       
11时34分27秒  1000      2495    0.99    0.99    0.00    0.99    1.98     1  sunloginclient                                                                                       
11时34分27秒  1000      2502    0.00    0.99    0.00    0.00    0.99     3  deepin-system-m                                                                                      
11时34分27秒  1000      2519    1.98    0.99    0.00    0.00    2.97     2  deepin-system-m                                                                                      
11时34分27秒  1000      2688    0.99    0.00    0.00    0.00    0.99     3  Foxmail.exe                                                                                          
11时34分27秒  1000      2752    0.99    0.00    0.00    0.00    0.99     0  winedevice.exe                                                                                       
11时34分27秒  1000      4825    0.99    0.00    0.00    0.00    0.99     3  deepin-terminal                                                                                      
11时34分27秒  1000      4864    0.99    0.99    0.00    0.00    1.98     2  dmanHelper                                                                                           
11时34分27秒  1000    161970    0.00    0.99    0.00    0.00    0.99     1  WeChat.exe                                                                                           
11时34分27秒  1000    161974    0.00    0.99    0.00    0.00    0.99     2  wineserver.real                                                                                      
11时34分27秒  1000    161996    0.00    0.99    0.00    0.00    0.99     1  winedevice.exe                                                                                       
11时34分27秒  1000    296137    0.00    0.99    0.00    0.00    0.99     3  chrome                                                                                               
11时34分27秒     0    300703    0.00    0.99    0.00    0.00    0.99     3  pidstat                                                                                              
                                                                                                                                                                                 
11时34分27秒   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
11时34分28秒     0       632    1.00    0.00    0.00    0.00    1.00     3  udisksd
11时34分28秒     0       777    1.00    0.00    0.00    0.00    1.00     1  Xorg                                                                                                 
11时34分28秒  1000      1752    1.00    0.00    0.00    0.00    1.00     3  dde-session-dae                                                                                      
11时34分28秒  1000      1961    0.00    1.00    0.00    0.00    1.00     0  dde-dock                                                                                             
11时34分28秒  1000      2495    0.00    1.00    0.00    0.00    1.00     2  sunloginclient                                                                                       
11时34分28秒  1000      2860    1.00    0.00    0.00    0.00    1.00     3  Foxmail.exe                                                                                          
11时34分28秒  1000      4825    1.00    0.00    0.00    0.00    1.00     0  deepin-terminal                                                                                      
11时34分28秒  1000    161970    1.00    0.00    0.00    0.00    1.00     3  WeChat.exe                                                                                           
11时34分28秒  1000    161974    0.00    1.00    0.00    0.00    1.00     1  wineserver.real                                                                                      
11时34分28秒  1000    162067    1.00    1.00    0.00    0.00    2.00     2  java                                                                                                 
11时34分28秒  1000    162167    0.00    1.00    0.00    0.00    1.00     0  WeChatPlayer.ex                                                                                      
11时34分28秒  1000    164242    1.00    0.00    0.00    0.00    1.00     1  java                                                                                                 
11时34分28秒     0    300341    0.00    1.00    0.00    0.00    1.00     3  kworker/3:2-events
```
1表示每秒输出一次，输出结果就是cpu占用，字段和之前介绍的命令差不多，这里不再详细描述。

> 通常会加上-r参数，用于展示每个进程内存页的换入换出情况，结合vmstat的si和so使用



### nice和renice
如果发现某个应用占用资源较高，尽管服务不是很重要但也不能直接杀掉，那么可以通过改变nice值降低其获取资源
的优先级，应用的nice值范围为-20到19，默认新进程nice值是0，nice值越高，越有机会抢占资源。

nice命令用于启动进程时指定nice值。
```shell
$ nice -n 15 ls
```
上面的命令以nice值15运行了ls。如果不带-n参数，默认值是10。


对于已经在运行的进程（通常情况下排查到问题进程都在运行），可以通过renice命令改变其nice值。
```shell
$ renice -n -10 -p 145
```

-n参数指定nice值，-p参数指定pid。注意大部分情况下可能需要root用户权限才能执行该命令。


## 磁盘部分
### df
df命令出了可以列出已用空间之外，还可以通过-i参数列出已使用的inode。
```shell
$ df -i
文件系统          Inode    已用(I)    可用(I)    已用(I)%    挂载点
udev             976331     534      975797       1%      /dev
tmpfs            988358    1052      987306       1%      /run
/dev/sda3      33218560  455243    32763317       2%      /
tmpfs            988358     350      988008       1%      /dev/shm
tmpfs            988358       4      988354       1%      /run/lock
tmpfs              1024      18        1006       2%      /sys/fs/cgroup
```
当可用inode不足时，应用程序可能报磁盘空间不足的错误，尽管此时仍然有很大的磁盘空间。


### iostat
iostat可以详细列出每个设备的io情况
```shell
$iostat 5
Linux 5.15.45-amd64-desktop (user-PC)   2023年01月11日  _x86_64_        (4 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           2.73    0.01    1.61    3.22    0.00   92.43

Device             tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn
sda              15.68       528.77       278.00   40841722   21472437

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           1.15    0.00    0.85    0.75    0.00   97.25

Device             tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn
sda              32.00         0.00       179.20          0        896

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.70    0.00    1.05    0.30    0.00   97.94

Device             tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn
sda               0.80         0.00        16.80          0         84

```
参数5表示每5s输出一次结果，没有该参数则只输出一次，还可以用***iostat 5 3***表示每5s输出一次，输出3次后停止

通常情况下还会带上-x参数，显示更详细的信息
```shell
$iostat -dx 3
Linux 5.15.45-amd64-desktop (user-PC)   2023年01月11日  _x86_64_        (4 CPU)

Device            r/s     w/s     rkB/s     wkB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util
sda              9.69    5.97    527.52    277.97     2.59     2.70  21.09  31.14   57.70   11.43   0.65    54.42    46.56   4.20   6.59                                                                                                    

Device            r/s     w/s     rkB/s     wkB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util
sda              0.33    1.00     42.67     50.67     0.00    11.67   0.00  92.11   22.00    8.67   0.02   128.00    50.67  14.00   1.87                                                                                                    

Device            r/s     w/s     rkB/s     wkB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util
sda              0.33    1.00      1.33      9.33     0.00     1.33   0.00  57.14   26.00    9.67   0.03     4.00     9.33  16.00   2.13
```
-d参数表示只输出Device（磁盘）的状态，-x参数则输出更详细的数据。 
需要注意%util这列，表示io占用率，如果比较高说明io负载高，通过下面的[iotop](2022-09-01-Linux性能问题一般排查步骤.md:260)命令查看负载最高的进程。
### iotop
类似top命令，iotop可以实时展示io最多的进程。


## 网络部分

### iftop
类似于top命令，iftop可以实时展示当前网络流量信息，还可以通过-i参数指定监听的网卡。

***iftop只能监听本地和远程ip的网络流量，无法监听本机内的流量，有这种需求的请用nethogs***

```shell
$ iftop
224.0.0.251            => localhost                 0b      0b      0b
                       <=                           0b    114b     81b
10.123.200.33          => stackoverflow.com         0b     42b     30b
                       <=                           0b     42b     30b
10.123.200.33          => 47.98.140.171             0b     42b     30b
                       <=                           0b     42b     30b
10.123.200.33          => 180.163.151.34            0b     42b     30b
                       <=                           0b     42b     30b
224.0.0.252            => 10.123.200.236            0b      0b      0b
                       <=                           0b     80b     57b
10.123.255.255         => 10.123.200.44             0b      0b      0b
                       <=                           0b     62b     45b
10.123.255.255         => 10.123.200.87             0b      0b      0b
                       <=                           0b     62b     45b
10.123.255.255         => localhost                 0b      0b      0b
                       <=                           0b     62b     45b
10.123.255.255         => localhost                 0b      0b      0b
                       <=                           0b     62b     45b
224.0.0.251            => 10.123.200.87             0b      0b      0b


TX:             cum:   4.03KB   peak:   4.37Kb                                                                                                   rates:   1.97Kb  2.22Kb  2.30Kb
RX:                    10.9KB           11.1Kb                                                                                                            5.76Kb  6.05Kb  6.24Kb
TOTAL:                 15.0KB           15.4Kb                                                                                                            7.73Kb  8.27Kb  8.54Kb
```

箭头方向指示了流量方向

### nethogs

```shell
$ nethogs
NetHogs version 0.8.5-2+b1

    PID USER     PROGRAM                                       DEV        SENT      RECEIVED       
 315130 user     /opt/Citrix/ICAClient/wfica                   enp1s0      0.229       0.219 KB/sec
    768 root     /opt/apps/com                                 enp1s0      0.037       0.038 KB/sec
 354636 user     ..pt/apps/cn.google.chrome/files/chrome       enp1s0      0.000       0.000 KB/sec
      ? root     unknown TCP      
```
展示了应用pid、名称等信息。